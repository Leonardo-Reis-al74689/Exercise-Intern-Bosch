name: Keep Render Alive

# Executar a cada 14 minutos para evitar cold start
# Render free tier: dorme apÃ³s 15min de inatividade
on:
  schedule:
    # Cron: a cada 14 minutos
    # Formato: minute hour day month weekday
    - cron: '*/14 * * * *'
  
  # Permitir execuÃ§Ã£o manual
  workflow_dispatch:

# PermissÃµes mÃ­nimas necessÃ¡rias
permissions:
  contents: read

jobs:
  ping:
    name: Ping Backend
    runs-on: ubuntu-latest
    
    # Timeout de 5 minutos (cold start pode demorar ~60s)
    timeout-minutes: 5
    
    steps:
      - name: ğŸ”„ Ping ao backend
        run: |
          echo "ğŸ”„ A verificar backend..."
          
          # URL do backend (definir como secret no GitHub)
          # Settings > Secrets and variables > Actions > New repository secret
          # Nome: BACKEND_URL
          # Valor: https://seu-backend.onrender.com
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          
          # Verificar se a variÃ¡vel estÃ¡ definida
          if [ -z "$BACKEND_URL" ]; then
            echo "âš ï¸ BACKEND_URL nÃ£o estÃ¡ definido nos secrets"
            echo "â„¹ï¸ Configure em: Settings > Secrets and variables > Actions"
            exit 0
          fi
          
          # Fazer request ao health check
          HEALTH_URL="${BACKEND_URL}/health"
          echo "ğŸ“ URL: $HEALTH_URL"
          
          # Request com timeout de 120s (para cold start)
          response=$(curl -s -w "\n%{http_code}" --max-time 120 "$HEALTH_URL" || echo "ERROR")
          
          # Extrair status code
          http_code=$(echo "$response" | tail -n 1)
          body=$(echo "$response" | head -n -1)
          
          # Verificar resultado
          if [ "$http_code" = "200" ]; then
            echo "âœ… Backend operacional!"
            echo "ğŸ“Š Resposta: $body"
            exit 0
          elif [ "$http_code" = "ERROR" ]; then
            echo "â±ï¸ Timeout ou erro de conexÃ£o (normal se estiver a acordar)"
            exit 0
          else
            echo "âš ï¸ Status code inesperado: $http_code"
            echo "ğŸ“„ Resposta: $body"
            exit 0
          fi
      
      - name: ğŸ“Š EstatÃ­sticas
        if: always()
        run: |
          echo "â° Timestamp: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          echo "ğŸ”„ PrÃ³ximo ping em ~14 minutos"

  # Job adicional para verificar se o serviÃ§o estÃ¡ consistentemente down
  health-check:
    name: Health Check Detalhado
    runs-on: ubuntu-latest
    needs: ping
    if: always()
    
    steps:
      - name: ğŸ¥ VerificaÃ§Ã£o de saÃºde
        run: |
          BACKEND_URL="${{ secrets.BACKEND_URL }}"
          
          if [ -z "$BACKEND_URL" ]; then
            echo "â„¹ï¸ Configure BACKEND_URL nos secrets do GitHub"
            exit 0
          fi
          
          echo "ğŸ” A verificar estado do serviÃ§o..."
          
          # Tentar 3 vezes com intervalo de 30s
          for i in 1 2 3; do
            echo "Tentativa $i/3..."
            
            response=$(curl -s -w "\n%{http_code}" --max-time 60 "${BACKEND_URL}/health" || echo "ERROR")
            http_code=$(echo "$response" | tail -n 1)
            
            if [ "$http_code" = "200" ]; then
              echo "âœ… ServiÃ§o respondeu na tentativa $i"
              exit 0
            fi
            
            if [ $i -lt 3 ]; then
              echo "â³ A aguardar 30s antes da prÃ³xima tentativa..."
              sleep 30
            fi
          done
          
          echo "âš ï¸ ServiÃ§o nÃ£o respondeu apÃ³s 3 tentativas"
          echo "â„¹ï¸ Isto Ã© normal se o serviÃ§o estiver em cold start"

# CONFIGURAÃ‡ÃƒO NECESSÃRIA:
# ========================
# 1. Ir para: Settings > Secrets and variables > Actions
# 2. Criar novo secret:
#    Nome: BACKEND_URL
#    Valor: https://seu-backend.onrender.com (sem barra no final)
#
# 3. Este workflow executarÃ¡ automaticamente a cada 14 minutos
#
# 4. Para desativar temporariamente:
#    - Ir para Actions > Keep Render Alive
#    - Clicar nos ... > Disable workflow
#
# 5. Para testar manualmente:
#    - Ir para Actions > Keep Render Alive
#    - Clicar em "Run workflow"
#
# NOTAS:
# ======
# - GitHub Actions tem limite de 2000 minutos/mÃªs no plano gratuito
# - Este workflow usa ~5 minutos/dia = ~150 minutos/mÃªs
# - Bem dentro do limite gratuito
# - O serviÃ§o Render acordarÃ¡ em 30-60 segundos no primeiro request

